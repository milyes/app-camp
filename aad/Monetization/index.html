
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://microsoft.github.io/app-camp/aad/Monetization/">
      
      
        <link rel="prev" href="../MessagingExtension/">
      
      
        <link rel="next" href="../ExtendTeamsApp/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.31">
    
    
      
        <title>Selling Your SaaS-based Teams Extension - Teams App Camp</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3cba04c6.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/labStyles.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="#35258F" data-md-color-accent="#091F2C">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#selling-your-saas-based-teams-extension" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Teams App Camp" class="md-header__button md-logo" aria-label="Teams App Camp" data-md-component="logo">
      
  <img src="../../assets/microsoftteams_appcamp-webheader3.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Teams App Camp
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Selling Your SaaS-based Teams Extension
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/microsoft/app-camp" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    microsoft/app-camp
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../new-adventure/00-welcome/" class="md-tabs__link">
          
  
  New Adventure

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../A01-begin-app/" class="md-tabs__link">
          
  
  A Path

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../bespoke/B01-begin-app/" class="md-tabs__link">
          
  
  B Path

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../ExtendedLabs/" class="md-tabs__link">
          
  
  Extended labs

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../Resources/" class="md-tabs__link">
          
  
  Resources

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Teams App Camp" class="md-nav__button md-logo" aria-label="Teams App Camp" data-md-component="logo">
      
  <img src="../../assets/microsoftteams_appcamp-webheader3.png" alt="logo">

    </a>
    Teams App Camp
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/microsoft/app-camp" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    microsoft/app-camp
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    New Adventure
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            New Adventure
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../new-adventure/00-welcome/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Welcome to another App Camp adventure!
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../new-adventure/01-create-app/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1 - Create a new app with Teams Toolkit
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../new-adventure/02-integrate-web-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2 - Integrate business data with your app
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../new-adventure/03-add-link-unfurling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3 - Link Unfurling
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../new-adventure/04-add-ai/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4 - Action message extensions with Open AI
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../new-adventure/05-add-sso/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5 - Single Sign-on and Microsoft Graph
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../new-adventure/06-run-in-outlook/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6 - Run your app in Microsoft Outlook
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    A Path
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            A Path
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../A01-begin-app/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    A01 - Start with Azure Active Directory
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../A02-after-teams-sso/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    A02 - Create a Teams app with Azure AD Teams SSO
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../A03-after-apply-styling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    A03 - Teams styling and themes
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    B Path
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            B Path
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bespoke/B01-begin-app/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    B01 - Start with a non-Azure Active Directory Identity System
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bespoke/B02-after-teams-login/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    B02 - Teams App with Bespoke Authentication
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bespoke/B03-after-teams-sso/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    B03 - Enable Azure AD Single Sign-On
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bespoke/B04-after-apply-styling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    B04 - Teams styling and themes
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Extended labs
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Extended labs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ExtendedLabs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Choose your own adventure!
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ConfigurableTab/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Add a configurable tab
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Deeplink/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Add a Deep link to a personal Tab
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Dialog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Add a Dialog
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../MeetingConfigurableTab/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Add a Meeting app
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../MessagingExtension/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Add a Message Extension
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Selling Your SaaS-based Teams Extension
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Selling Your SaaS-based Teams Extension
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#exercise-1-update-env" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 1: Update .env
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercise-2-northwind-orders-calls-the-licensing-service" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 2: Northwind Orders calls the licensing service
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exercise 2: Northwind Orders calls the licensing service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-add-server-side-code-to-validate-the-user-has-a-license" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1: Add server side code to validate the user has a license
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-add-a-server-side-api-to-validate-the-users-license" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2: Add a server side API to validate the user's license
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-add-client-pages-to-display-a-license-error" class="md-nav__link">
    <span class="md-ellipsis">
      Step 3: Add client pages to display a license error
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-check-if-the-user-has-a-license" class="md-nav__link">
    <span class="md-ellipsis">
      Step 4: Check if the user has a license
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-5-call-the-license-api" class="md-nav__link">
    <span class="md-ellipsis">
      Step 5: Call the license API
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercise-3-grant-consent-to-the-licensing-api" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 3: Grant consent to the licensing API
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exercise 3: Grant consent to the licensing API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-add-the-api-to-apis-that-your-organization-uses" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1: Add the API to APIs that your organization uses
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercise-4-run-the-application" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 4: Run the application
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exercise 4: Run the application">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-run-teams-without-a-license" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1: Run Teams without a license
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-purchase-a-subscription-and-set-licensing-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2: Purchase a subscription and set licensing policy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-run-the-application-in-teams" class="md-nav__link">
    <span class="md-ellipsis">
      Step 3: Run the application in Teams
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercise-5-inspect-the-licensing-code" class="md-nav__link">
    <span class="md-ellipsis">
      Exercise 5: Inspect the licensing code
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exercise 5: Inspect the licensing code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-resolving-the-marketplace-token" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1: Resolving the Marketplace Token
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-examine-web-hooks" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2: Examine web hooks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-examine-the-license-check" class="md-nav__link">
    <span class="md-ellipsis">
      Step 3: Examine the license check
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#congratulations" class="md-nav__link">
    <span class="md-ellipsis">
      Congratulations!
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Congratulations!">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#known-issues" class="md-nav__link">
    <span class="md-ellipsis">
      Known issues
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Next steps
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ExtendTeamsApp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Extend teams app to Outlook and Microsoft365 app
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Resources
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Resources
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Resources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    More Information
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../in-a-box/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lead your own App Camp
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "dfh6fjbr5x");
</script>

<p><img alt="Teams App Camp" src="/app-camp/assets/code-lab-banner.png" /></p>
<h1 id="selling-your-saas-based-teams-extension">Selling Your SaaS-based Teams Extension</h1>
<div class="admonition important">
<p class="admonition-title">Important!</p>
<p>This lab builds on the completed solution to lab <a href="/app-camp/aad/A03-after-apply-styling">A03-after-apply-styling.md</a>, which is the last of the "core" labs. If you haven't done them, you can <a href="/app-camp/aad/A01-begin-app">start here</a>.</p>
</div>
<p>In this lab, you'll allow users to purchase subscriptions for your Northwind Orders application as a transactable offer in a <strong>mock</strong> AppSource marketplace. This is similar to the purchase experience for apps listed in the Teams App Store, and it allows you to do this lab without a Partner Center account, which is required to create offers in the real AppSource. Additionally, you will integrate the Northwind Orders application with a simple licensing service that allows you to purchase licenses for your SaaS application. When you're done the Northwind Orders application will require a license to run in Teams, but will not require a license when accessing it directly. </p>
<p>The AppSource simulator, as well as a sample license service, can be found <a href="https://github.com/OfficeDev/office-add-in-saas-monetization-sample" target="_blank">in this github repository</a>. The repo includes:</p>
<ul>
<li>An <a href="https://github.com/OfficeDev/office-add-in-saas-monetization-sample/tree/master/MonetizationCodeSample/AppSourceMockWebApp" target="_blank">AppSource simulator (web site)</a></li>
<li>A <a href="https://github.com/OfficeDev/office-add-in-saas-monetization-sample/tree/master/MonetizationCodeSample/SaaSSampleWebApi" target="_blank">sample license service</a> similar to one you need to provide for your app</li>
<li>A <a href="https://github.com/OfficeDev/office-add-in-saas-monetization-sample/tree/master/MonetizationCodeSample/SaaSSampleWebApp" target="_blank">web site with a landing page</a> similar to the one you need to provide for your app</li>
</ul>
<p>You will need to install these services in your Azure subscription before this lab will work. You can find instructions 
<a href="/app-camp/supplemental/MonetizationLabSetup">here</a>. Be aware that the <a href="https://github.com/OfficeDev/office-add-in-saas-monetization-sample/tree/master/MonetizationCodeSample/SaaSSampleWebApi" target="_blank">license service</a>  and <a href="https://github.com/OfficeDev/office-add-in-saas-monetization-sample/tree/master/MonetizationCodeSample/SaaSSampleWebApp" target="_blank">web site with landing page</a>  are only samples and that your app would need to implement something similar!</p>
<details class="info" open="open">
<summary>Video briefing</summary>
<p><div class="tinyVideo">
  <iframe src="//www.youtube.com/embed/v-Ahdkjs7TY" frameborder="0" allowfullscreen></iframe>
  <div>Anatomy of a SaaS Application</div>
</div>
<div class="tinyVideo">
  <iframe src="//www.youtube.com/embed/qvLofi22paw" frameborder="0" allowfullscreen></iframe>
  <div>Monetization lab walkthrough</div>
</div></p>
</details>
<details class="attention" open="open">
<summary>Key learning resource</summary>
<p>For a complete on-demand workshop focused on Commercial Marketplace, complete with hands-on labs and videos, please visit Mastering the Marketplace. Monetized Teams Store Apps are "SaaS Offers", so <a href="http://aka.ms/mastering-the-marketplace/saas" target="_blank">the link</a> will bring you directly into that section of the training.
<div style="display:flex; width:100%; justify-content: center;">
<a href="http://aka.ms/mastering-the-marketplace/saas" target="_blank">
<img src="/app-camp/assets/MasteringTheMarketplaceLogo.png" alt="Mastering the Marketplace logo"></img></a></div></p>
</details>
<h2 id="exercise-1-update-env">Exercise 1: Update .env</h2>
<p>In this exercise, you will add information to your environment file about the hosted licensing service.</p>
<p>Your <code>.env</code> file on the Northwind Orders application needs to be updated to include values that will allow it to interact with the licensing service. This service is centrally located and you share it with the other lab participants. </p>
<p>Go back to your working directory and add the below entries into <code>.env</code> file, using values from when you set up the licensing service.</p>
<pre><code class="language-text">SAAS_API=https://&lt;saasmonetizationwebapi&gt;.azurewebsites.net/api/Subscriptions/CheckOrActivateLicense
SAAS_SCOPES=api://saasmonetizationwebapi-aad-app-clientid/user_impersonation
OFFER_ID=&lt;offername&gt;
</code></pre>
<h2 id="exercise-2-northwind-orders-calls-the-licensing-service">Exercise 2: Northwind Orders calls the licensing service</h2>
<p>In this exercise, you will update the Northwind Orders app to call the licensing service.</p>
<h3 id="step-1-add-server-side-code-to-validate-the-user-has-a-license">Step 1: Add server side code to validate the user has a license</h3>
<ol>
<li>
<p>In your working folder, create a new file <code>/server/validateLicenseService.js</code> </p>
</li>
<li>
<p>Paste in the following code (or copy the file from <a href="https://github.com/microsoft/app-camp/blob/main/src/extend-with-capabilities/Monetization/client/modules/northwindLicensing.js" target="_blank">here</a>).</p>
</li>
</ol>
<p>This code verifies the user has a license to use the Northwind Orders application. The license will only be checked when the application is being used via Teams.</p>
<pre><code class="language-javascript">import aad from 'azure-ad-jwt';
import fetch from 'node-fetch';

export async function validateLicense(thisAppAccessToken) {

    const audience = `api://${process.env.HOSTNAME}/${process.env.CLIENT_ID}`;
    return new Promise((resolve, reject) =&gt; {

        aad.verify(thisAppAccessToken, { audience: audience }, async (err, result) =&gt; {
            if (result) {
                const licensingAppUrl = `${process.env.SAAS_API}/${process.env.OFFER_ID}`
                const licensingAppAccessToken = await getOboAccessToken(thisAppAccessToken);
                if (licensingAppAccessToken === &quot;interaction_required&quot;) {
                    reject({ &quot;status&quot;:401, &quot;message&quot;: &quot;Interaction required&quot;});
                }

                const licensingResponse = await fetch(licensingAppUrl, {
                    method: &quot;POST&quot;,
                    headers: {
                        &quot;Accept&quot;: &quot;application/json&quot;,
                        &quot;Content-Type&quot;: &quot;application/json&quot;,
                        &quot;Authorization&quot; :`Bearer ${licensingAppAccessToken}`
                    }
                });
                if (licensingResponse.ok) {
                    const licensingData = await licensingResponse.json();
                    console.log(licensingData.reason);
                    resolve(licensingData);
                } else {
                    reject({ &quot;status&quot;: licensingResponse.status, &quot;message&quot;: licensingResponse.statusText });
                }
            } else {
                reject({ &quot;status&quot;: 401, &quot;message&quot;: &quot;Invalid client access token in northwindLicenseService.js&quot;});
            }
        });
    });

}

// TODO: Securely cache the results of this function for the lifetime of the resulting token
async function getOboAccessToken(clientSideToken) {

    const tenantId = process.env.TENANT_ID;
    const clientId = process.env.CLIENT_ID;
    const clientSecret = process.env.CLIENT_SECRET;
    const scopes = process.env.SAAS_SCOPES;

    // Use On Behalf Of flow to exchange the client-side token for an
    // access token with the needed permissions

    const INTERACTION_REQUIRED_STATUS_TEXT = &quot;interaction_required&quot;;
    const url = &quot;https://login.microsoftonline.com/&quot; + tenantId + &quot;/oauth2/v2.0/token&quot;;
    const params = {
        client_id: clientId,
        client_secret: clientSecret,
        grant_type: &quot;urn:ietf:params:oauth:grant-type:jwt-bearer&quot;,
        assertion: clientSideToken,
        requested_token_use: &quot;on_behalf_of&quot;,
        scope: scopes
    };

    const accessTokenQueryParams = new URLSearchParams(params).toString();
    try {
        const oboResponse = await fetch(url, {
            method: &quot;POST&quot;,
            body: accessTokenQueryParams,
            headers: {
                Accept: &quot;application/json&quot;,
                &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;
            }
        });

        const oboData = await oboResponse.json();
        if (oboResponse.status !== 200) {
            // We got an error on the OBO request. Check if it is consent required.
            if (oboData.error.toLowerCase() === 'invalid_grant' ||
                oboData.error.toLowerCase() === 'interaction_required') {
                throw (INTERACTION_REQUIRED_STATUS_TEXT);
            } else {
                console.log(`Error returned in OBO: ${JSON.stringify(oboData)}`);
                throw (`Error in OBO exchange ${oboResponse.status}: ${oboResponse.statusText}`);
            }
        }
        return oboData.access_token;
    } catch (error) {
        return error;
    }

}
</code></pre>
<h3 id="step-2-add-a-server-side-api-to-validate-the-users-license">Step 2: Add a server side API to validate the user's license</h3>
<p>Now that you have server-side code that checks the user has a license, you need to add code that validates the that license. You'll add a POST request to the the Northwind Orders application that calls the licensing service API.</p>
<ol>
<li>In your working folder, locate the file <code>server/server.js</code> and open it in your code editor.</li>
<li>Add these lines to the top of the file.</li>
</ol>
<pre><code class="language-javascript">import aad from 'azure-ad-jwt';
import { validateLicense } from './validateLicenseService.js';
</code></pre>
<ol>
<li>Immediately below the call to <code>await initializeIdentityService()</code>, add the following code.</li>
</ol>
<pre><code class="language-javascript">// Web service validates a user's license
app.post('/api/validateLicense', async (req, res) =&gt; {

  try {
    const token = req.headers['authorization'].split(' ')[1];

    try {
      let hasLicense = await validateLicense(token);
      res.send(JSON.stringify({ &quot;validLicense&quot; : hasLicense }));
    }
    catch (error) {
      console.log (`Error ${error.status} in validateLicense(): ${error.message}`);
      res.status(error.status).send(error.message);
    }
  }
  catch (error) {
      console.log(`Error in /api/validateAadLogin handling: ${error}`);
      res.status(500).json({ status: 500, statusText: error });
  }

});
</code></pre>
<h3 id="step-3-add-client-pages-to-display-a-license-error">Step 3: Add client pages to display a license error</h3>
<p>The app needs to be able to show if there is a licensing error. This step adds that code to the client.</p>
<ol>
<li>Add a new file, <code>client/pages/needLicense.html</code>. </li>
<li>Paste in the following HTML (or copy the file from <a href="https://github.com/microsoft/app-camp/blob/main/src/extend-with-capabilities/Monetization/client/pages/needLicense.html">here</a>).</li>
</ol>
<pre><code class="language-html">&lt;!doctype html&gt;
&lt;html&gt;

&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot; /&gt;
    &lt;title&gt;Northwind Privacy&lt;/title&gt;
    &lt;link rel=&quot;icon&quot; href=&quot;data:;base64,=&quot;&gt; &lt;!-- Suppress favicon error --&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;/northwind.css&quot; /&gt;

&lt;/head&gt;

&lt;body class=&quot;ms-Fabric&quot; dir=&quot;ltr&quot;&gt;   
    &lt;h1&gt;Sorry you need a valid license to use this application&lt;/h1&gt;
    &lt;p&gt;Please purchase a license from the Microsoft Teams store.       
    &lt;/p&gt;
    &lt;div id=&quot;errorMsg&quot;&gt;&lt;/div&gt;
    &lt;script type=&quot;module&quot; src=&quot;needLicense.js&quot;&gt;&lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre>
<p>The HTML page needs some JavaScript to work properly.</p>
<ol>
<li>Create a file <code>/client/pages/needLicense.js</code>.</li>
<li>Paste in the following code (or copy the file from <a href="https://github.com/microsoft/app-camp/blob/main/src/extend-with-capabilities/Monetization/client/pages/needLicense.js">here</a>).</li>
</ol>
<pre><code class="language-javascript">const searchParams = new URLSearchParams(window.location.search);

if (searchParams.has('error')) {
    const error = searchParams.get('error');
    const displayElementError = document.getElementById('errorMsg');
    displayElementError.innerHTML = error;  
}
</code></pre>
<h3 id="step-4-check-if-the-user-has-a-license">Step 4: Check if the user has a license</h3>
<p>In this step, you will add client side function to check if the user has a license.</p>
<ol>
<li>Add a new file, <code>client/modules/northwindLicensing.js</code>.</li>
<li>Paste in the following code (or copy the file from <a href="https://github.com/microsoft/app-camp/blob/main/src/extend-with-capabilities/Monetization/client/modules/northwindLicensing.js">here</a>). </li>
</ol>
<p>This code calls the server-side API we just added using an Azure AD token obtained using Microsoft Teams SSO.</p>
<pre><code class="language-javascript">import 'https://res.cdn.office.net/teams-js/2.0.0/js/MicrosoftTeams.min.js';
import { ensureTeamsSdkInitialized } from './teamsHelpers.js';

export async function hasValidLicense() {

    await new Promise((resolve, reject) =&gt; {
        microsoftTeams.initialize(() =&gt; { resolve(); });
    });

    await ensureTeamsSdkInitialized();
    const authToken = await microsoftTeams.authentication.getAuthToken();

    const response = await fetch(`/api/validateLicense`, {
        &quot;method&quot;: &quot;post&quot;,
        &quot;headers&quot;: {
            &quot;content-type&quot;: &quot;application/json&quot;,
            &quot;authorization&quot;: `Bearer ${authToken}`
        },
        &quot;cache&quot;: &quot;no-cache&quot;
    });

    if (response.ok) {

        const data = await response.json();
        return data.validLicense;

    } else {

        const error = await response.json();
        console.log(`ERROR: ${error}`);

    }

}
</code></pre>
<h3 id="step-5-call-the-license-api">Step 5: Call the license API</h3>
<p>In this step, you'll add client side code that checks the user's license on every request.</p>
<ol>
<li>Open the file <code>client/identity/userPanel.js</code> in your code editor. 
    This is a web component that displays the user's picture and name on every page, so it's an easy place to check the license.</li>
<li>Add these imports at the top of the file.</li>
</ol>
<pre><code class="language-javascript">import { hasValidLicense } from '../modules/northwindLicensing.js';
import { inTeams } from '../modules/teamsHelpers.js';
</code></pre>
<ol>
<li>Add the following code at the top of the <code>else</code> clause within the <code>connectedCallback()</code> function.</li>
</ol>
<pre><code class="language-javascript">    if (await inTeams()) {
        const validLicense = await hasValidLicense();  
        if (validLicense.status &amp;&amp; validLicense.status.toString().toLowerCase()===&quot;failure&quot;) {
                window.location.href =`/pages/needLicense.html?error=${validLicense.reason}`;
        }    
    }
</code></pre>
<p>The completed <code>userPanel.js</code> should look like the following code.</p>
<pre><code class="language-javascript">import {
    getLoggedInEmployee,
    logoff
} from './identityClient.js';
import { inTeams } from '../modules/teamsHelpers.js';
import { hasValidLicense } from '../modules/northwindLicensing.js';

class northwindUserPanel extends HTMLElement {

    async connectedCallback() {

        const employee = await getLoggedInEmployee();

        if (!employee) {

            logoff();

        } else {

            if (await inTeams()) {
                const validLicense = await hasValidLicense();  
                if (validLicense.status &amp;&amp; validLicense.status.toString().toLowerCase()===&quot;failure&quot;) {
                     window.location.href =`/pages/needLicense.html?error=${validLicense.reason}`;
                }    
            }

            this.innerHTML = `&lt;div class=&quot;userPanel&quot;&gt;
                &lt;img src=&quot;data:image/bmp;base64,${employee.photo}&quot;&gt;&lt;/img&gt;
                &lt;p&gt;${employee.displayName}&lt;/p&gt;
                &lt;p&gt;${employee.jobTitle}&lt;/p&gt;
                &lt;hr /&gt;
                &lt;button id=&quot;logout&quot;&gt;Log out&lt;/button&gt;
            &lt;/div&gt;
            `;

            const logoutButton = document.getElementById('logout');
            logoutButton.addEventListener('click', async ev =&gt; {
                logoff();
            });
        }
    }
}

// Define the web component and insert an instance at the top of the page
customElements.define('northwind-user-panel', northwindUserPanel);
const panel = document.createElement('northwind-user-panel');
document.body.insertBefore(panel, document.body.firstChild);
</code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There are many ways to make the license check more robust, such as checking it on every web service call and caching this on the server side to avoid excessive calls to the licensing server. However this is just a lab so we wanted to keep it simple.</p>
</div>
<h2 id="exercise-3-grant-consent-to-the-licensing-api">Exercise 3: Grant consent to the licensing API</h2>
<p>In this exercise you will grant consent to the licensing API to be called from an application running in your tenant. Without this step, you server-side API call to the licensing service would fail.</p>
<h3 id="step-1-add-the-api-to-apis-that-your-organization-uses">Step 1: Add the API to APIs that your organization uses</h3>
<p>Here you will construct and call a URL that grants tenant-wide admin consent.</p>
<p>The form this URL will take is as follows, where <code>tenant-id</code> is your tenant and <code>client-id</code> is the ID of the licensing API being called by the server code.</p>
<p><code>https://login.microsoftonline.com/{tenant-id}/adminconsent?client_id={client-id}</code></p>
<ol>
<li>Open your <code>.env</code> file. All the information you need to construct the URL is in this file.</li>
<li>In a separate file, paste the URL as shown above.</li>
<li>Replace <code>{tenant-id}</code> with the TENANT_ID value from the <code>.env</code> file.</li>
<li>In the <code>SAAS_SCOPES</code> section is the scope of the licensing service API. Copy the GUID from this scope and use it to replace <code>{client-id}</code> in the URL you are constructing. The result should look something like this.</li>
</ol>
<blockquote>
<p><code>https://login.microsoftonline.com/1661a74b-21d8-4cc9-9e09-e258e0a18291/adminconsent?client_id=dd82efdc-c77f-49c1-9b18-ca3d76a36264</code></p>
</blockquote>
<ol>
<li>Now make your tenant aware of the licensing API by going to this URL in a browser. Paste the URL into a browser and hit <strong>enter</strong>.</li>
</ol>
<p>You will be redirected to a page that looks for localhost and throws an error. Don't worry, this is expected behavior. </p>
<p>You can close this browser window.</p>
<ol>
<li>Open your browser to your Azure portal using your M365 credentials used for this class.</li>
<li>Click on <strong>Azure Active Directory &gt; App registrations</strong>.</li>
<li>Click the <strong>Northwind Orders</strong> app registration.</li>
<li>
<p>Click <strong>API permissions</strong>.</p>
<p>You are going to add a permission to this app registration allowing the Northwind Orders application to communicate with the licensing service API.</p>
</li>
<li>
<p>Click <strong>Add a permission</strong>.</p>
</li>
<li>
<p>At the top of the flyout, click <strong>APIs my organization uses</strong>.</p>
<p>Because you granted cross tenant access above, the Contoso Web API will be in the list of APIs.</p>
</li>
<li>
<p>Type <strong>Contoso Monetization Code Sample Web API</strong>.</p>
</li>
<li>Select the API.</li>
<li>Ensure the <strong>user_impersonation</strong> permission is selected.</li>
<li>Click <strong>Add a permission</strong>.</li>
<li>
<p>Click <strong>Grant admin consent</strong> for (tenant name)" to the right of the <strong>Add a Permission</strong> button, and click the <strong>Yes</strong> button to confirm.</p>
<p>Now the Northwind Orders app registration allows the Northwind Orders application to call the licensing service API.</p>
</li>
</ol>
<h2 id="exercise-4-run-the-application">Exercise 4: Run the application</h2>
<p>Now that all the pieces are in place, it's time to run the application you've set up.</p>
<h3 id="step-1-run-teams-without-a-license">Step 1: Run Teams without a license</h3>
<p>In this initial step, you'll run the application without a user license to see how the application behaves.</p>
<ol>
<li>Ensure your NW Trader Orders application is running with the new code you just added. Restart if it is currently running.</li>
<li>Return to your application in Microsoft Teams.</li>
<li>Refresh the tab or browser if necessary. 
   The UI will begin to render, and then it will detect the license failure and display an error page.</li>
</ol>
<p><img alt="Run application" src="/app-camp/assets/screenshots/08-201-RunApp-1.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The sample application checks the license in JavaScript, which is convenient for this lab but it would be easy for someone to bypass the license check. In a real application you'd probably check the license on all accesses to your application web site.</p>
</div>
<h3 id="step-2-purchase-a-subscription-and-set-licensing-policy">Step 2: Purchase a subscription and set licensing policy</h3>
<p>In a real-world situation, your SaaS offer is listed in the <strong>Teams Store</strong> and the <strong>Microsoft AppSource marketplace</strong>. Users can purchase your app in either location. </p>
<p>For this lab you will use an <strong>AppSource</strong> simulator to mock your interactions with the actual marketplace. Just know that Teams users can purchase apps directly from the user interface when they're listed in the Teams app store.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For your convenience, app service simulator is temporarily hosted at https://bgmonetizationappsource.azurewebsites.net/. If you'd prefer to host it yourself, the instructions are <a href="/app-camp/docs/MonetizationLabSetup.md">here</a>.</p>
</div>
<ol>
<li>
<p>Browse to mock AppSource URL. This should display the <strong>AppSource</strong> simulator. </p>
</li>
<li>
<p>Click the <strong>Purchase</strong> button to purchase a subscription to the Northwind Orders application.</p>
</li>
</ol>
<p><img alt="Run application" src="/app-camp/assets/screenshots/08-202-RunApp-2.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Notice that the <strong>AppSource</strong> simulator's background color is green to make it easy to distinguish from your app's landing page, which has a blue background.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <strong>AppSource</strong> simulator has a mock offer name, "Contoso Apps", rather than showing the "Northwind Orders" app. This is just a constant defined in the monetization project's <code>SaasOfferMockData/Offers.cs</code> file.
The real <strong>AppSource</strong> web page shows the application name and other information you would configure in Partner Center.</p>
</div>
<p>The <strong>AppSource</strong> simulator displays the plans available for the offer. The simulator has two hard-coded plans, "SeatBasedPlan" (which uses a <a href="https://docs.microsoft.com/en-us/azure/marketplace/create-new-saas-offer-plans?WT.mc_id=m365-58890-cxa" target="_blank">per-user pricing model</a>), and a "SiteBasedPlan" (which uses a <a href="https://docs.microsoft.com/en-us/azure/marketplace/plan-saas-offer?WT.mc_id=m365-58890-cxa#saas-pricing-models" target="_blank">flat-rate pricing model</a>). </p>
<p>The real <strong>AppSource</strong> would show the plans you had defined in Partner Center, the publisher's portal for defining and publishing <strong>AppSource</strong> offers.</p>
<p>Microsoft Teams currently supports only the per-user pricing model</p>
<ol>
<li>Select the "SeatBasedPlan" and click the <strong>Purchase</strong> button. Because this is a simulator, your credit card will not be charged.</li>
</ol>
<p><img alt="Run application" src="/app-camp/assets/screenshots/08-203-RunApp-3.png" /></p>
<p>The simulated purchase is now complete, so you will be redirected to the app's landing page. </p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>For your convenience, the web site containing the landing page is temporarily hosted at https://bgmonetizationwebapp.azurewebsites.net/. If you'd prefer to install the services on Azure and host it yourself, the instructions are <a href="/app-camp/docs/MonetizationLabSetup.md">here</a>.</p>
</div>
<p>The landing page gives the app a chance to interact with the user and capture any configuration information it needs. Users who purchase the app in the Teams store would be brought to this same page. </p>
<p>You will need to supply a page like this as part of your application; it interprets a token sent by <strong>AppSource</strong> and logs the user in with AAD SSO. This token is then sent to the <strong>SaaS Fulfillment API v2</strong>, which provides the details of the customer's subscription. </p>
<p>The sample app's landing page allows the user to select a region; the app stores this information in its own database. Notice the background color of these pages is blue; the blue pages are for your application to implement and are only a sample we've hosted based on <a href="https://github.com/OfficeDev/office-add-in-saas-monetization-sample" target="_blank">this sample</a>.</p>
<p><img alt="Run application" src="/app-camp/assets/screenshots/08-204-RunApp-4.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Notice that the <strong>Landing Page</strong> and licensing pages' background color is blue to make it easy to distinguish from the App Source Simulator, which has a green background.</p>
</div>
<div class="admonition warning reminder">
<p class="admonition-title">Warning</p>
<p>Even though this lab didn't walk you through creating the landing page and other licnsing pages (the blue ones) - you as an application developer need to provide these. Many SaaS services may already have a licensing service and want to extend it to work with the Microsoft Commercial Marketplace. We're working on more options to make this easier, both for ISV's with existing licensing services and those who need a new one.</p>
</div>
<p>Once the region is selected, the sample app shows a welcome page with the user's name, which is obtained by <a href="https://docs.microsoft.com/en-us/graph/api/user-get?view=graph-rest-1.0&amp;WT.mc_id=m365-58890-cxa" target="_blank">reading the user's profile with the Microsoft Graph API</a>. </p>
<ol>
<li>Click <strong>License Settings</strong> to view the license assignment screen.</li>
</ol>
<p><img alt="Run application" src="/app-camp/assets/screenshots/08-205-RunApp-5.png" /></p>
<p>On this screen you can add individual user licenses using the <strong>Add User</strong> button, or you can set a policy that allows users to claim licenses on a first come, first served basis. Turn on the <strong>First come first served</strong> switch to enable this option.</p>
<p><img alt="Run application" src="/app-camp/assets/screenshots/08-206-RunApp-6.png" /></p>
<div class="admonition warning reminder">
<p class="admonition-title">Warning</p>
<p>Everything on this screen is defined by the your SaaS application. It's intended to be flexible since publishers have a wide range of licensing approaches. Apps can tell who's logging in via Azure AD and use the user ID and tenant ID to authorize access, provide personalization, etc.</p>
</div>
<h3 id="step-3-run-the-application-in-teams">Step 3: Run the application in Teams</h3>
<p>Now that you've purchased a subscription, you can see the Northwind Orders application in Teams.</p>
<ol>
<li>Return to Microsoft Teams and refresh your application. 
    The license will be approved and the user can interact with the application normally.</li>
</ol>
<p><img alt="Run application" src="/app-camp/assets/screenshots/08-208-RunApp-8.png" /></p>
<ol>
<li>Return to the licensing application.</li>
</ol>
<p>If you've closed the tab, you can find it at the mock AppSource URL you received earlier. </p>
<p><img alt="Run application" src="/app-camp/assets/screenshots/08-209-RunApp-9.png" /></p>
<p>Notice that your username has been assigned a license. The sample app stored this in a SQL Server database. When the Teams application called the licensing service, the access token contained the tenant ID and user ID, enabling the licensing service to determine that the user has a license.</p>
<h2 id="exercise-5-inspect-the-licensing-code">Exercise 5: Inspect the licensing code</h2>
<p>In this exercise, you'll inspect key areas of the sample licensing service used in this lab. In an actual application, you would write your own licensing service or extend your existing licensing service to integrate it with your SaaS offer on AppSource.</p>
<h3 id="step-1-resolving-the-marketplace-token">Step 1: Resolving the Marketplace Token</h3>
<p>When a user completes the process of purchasing your application in AppSource or the Microsoft Teams app store, they are directed to the app's <a href="https://docs.microsoft.com/en-us/azure/marketplace/azure-ad-transactable-saas-landing-page?WT.mc_id=m365-58890-cxa" target="_blank">landing page</a>. This URL is for a web page provided by the software vendor and registered in Partner Center. In this lab, the landing page is part of the <a href="https://github.com/OfficeDev/office-add-in-saas-monetization-sample/tree/master/MonetizationCodeSample/SaaSSampleWebApp" target="_blank">SaaSSampleWebApp</a> sample.</p>
<p>Microsoft sends a marketplace token to the landing page; eventually this is resolved in the sample app's <a href="https://github.com/OfficeDev/office-add-in-saas-monetization-sample/blob/7673db6c8e6c809ae7aa0ba894460183aed964fc/MonetizationCodeSample/SaaSSampleWebApi/Controllers/SubscriptionsController.cs#L134" target="_blank">Subscription service</a>.</p>
<pre><code class="language-csharp">[Route(&quot;resolve&quot;)]
[HttpPost]
public async Task&lt;IActionResult&gt; ResolveAsync([FromForm] string AuthCode)
{
    using var requestMessage = new HttpRequestMessage(HttpMethod.Post,
        $&quot;{_configuration[&quot;SaaSfulfillmentAPIs:ApiEndPoint&quot;]}/api/saas/subscriptions/resolve?api-version={_configuration[&quot;SaaSfulfillmentAPIs:ApiVersion&quot;]}&quot;);

    // the token is not required for Mock APIs 
    // requestMessage.Headers.Authorization = new AuthenticationHeaderValue(&quot;Bearer&quot;, your_token);

    requestMessage.Headers.Add(&quot;x-ms-marketplace-token&quot;, AuthCode);

    var httpClient = _httpClientFactory.CreateClient();

    using (var response = await httpClient.SendAsync(requestMessage).ConfigureAwait(false))
    {
        if (response.StatusCode == HttpStatusCode.OK)
        {
            var content = await response.Content.ReadAsStringAsync().ConfigureAwait(false);
            var resolvedSubscription = JsonConvert.DeserializeObject&lt;ResolvedSubscription&gt;(content);

            var subscription = new Subscription
            {
                Id = resolvedSubscription.Id,
                OfferId = resolvedSubscription.OfferId,
                PlanId = resolvedSubscription.PlanId,
                SubscriptionName = resolvedSubscription.SubscriptionName,
                Purchaser = HttpContext.User.Identity.Name,
                PurchaserId = Guid.Parse(HttpContext.User.GetObjectId()),
                TenantId = Guid.Parse(HttpContext.User.GetTenantId()),
                PurchaseSeatsCount = resolvedSubscription.Quantity,
                AllowOverAssignment = false,
                FirstComeFirstServedAssignment = false
            };
            return Ok(subscription);
        }
        return BadRequest(response.ReasonPhrase);
    }
}
</code></pre>
<p>The sample calls the AppSource simulator to get information about the subscription that was purchased. In your service, you would call <a href="https://docs.microsoft.com/en-us/azure/marketplace/partner-center-portal/pc-saas-fulfillment-subscription-api?WT.mc_id=m365-58890-cxa#resolve-a-purchased-subscription" target="_blank">this Marketplace API</a> to do this exchange.</p>
<h3 id="step-2-examine-web-hooks">Step 2: Examine web hooks</h3>
<p>In addition to a landing page, your application will need to provide a set of <a href="https://docs.microsoft.com/en-us/azure/marketplace/partner-center-portal/pc-saas-fulfillment-webhook" target="_blank">web hooks</a> that Microsoft can call to let you know about subscription changes. The sample app doesn't implement all the webhooks, but does implement a subset that are supported by the AppSource simulator. The <a href="https://github.com/OfficeDev/office-add-in-saas-monetization-sample/blob/7673db6c8e6c809ae7aa0ba894460183aed964fc/MonetizationCodeSample/SaaSSampleWebApi/Controllers/WebhookController.cs#L54" target="_blank">WebHookController</a> responds to these events:</p>
<ul>
<li><strong>ChangePlan</strong> - called when a user changes their offer plan, such as moving from a Silver to a Gold plan. Plans are defined by the software using Partner Center.</li>
<li><strong>ChangeQuantity</strong> - called when a user changes the quantity of seats in a per-seat SaaS offer</li>
<li><strong>Unsubscribe</strong> - called when a user cancels their subscription</li>
</ul>
<p>The full list of webhooks events is <a href="https://docs.microsoft.com/en-us/azure/marketplace/partner-center-portal/pc-saas-fulfillment-webhook?WT.mc_id=m365-58890-cxa" target="_blank">documented here</a>.</p>
<h3 id="step-3-examine-the-license-check">Step 3: Examine the license check</h3>
<p>In Exercise 2 you added <a href="https://github.com/microsoft/app-camp/blob/main/src/extend-with-capabilities/Monetization/server/validateLicenseService.js#L22" target="_blank">code to check if the user has a license</a>. This call is handled here, in the <a href="https://github.com/OfficeDev/office-add-in-saas-monetization-sample/blob/7673db6c8e6c809ae7aa0ba894460183aed964fc/MonetizationCodeSample/SaaSSampleWebApi/Controllers/SubscriptionsController.cs#L213" target="_blank">CheckOrAdtivateLicense</a> method in the Subscriptions controller. Notice that this code includes some business logic and accesses a license database in Azure SQL using Entity Framework. </p>
<p>The point of this is that the application is managing licenses in its own way and keeping track of them in its own database. Microsoft Commercial Marketplace manages subscriptions which grant licenses, but each application can manage those licenses however it wants to. This allows applications flexibility in how they implement licensing.</p>
<script language="javascript">
    function showCompletionPopup() {
        let path = window.location.pathname;
        path = path.endsWith('/') ? path.slice(0, -1) : path;
        let pathArray = path.split('/');
        let leafFolder = pathArray[pathArray.length-1];

        let height = window.outerHeight / 1.5;
        let width = window.outerWidth / 2;

        window.open(`${window.origin}/app-camp/congrats/${leafFolder}`,
                    'Congratulations!',
                    `width=${width}, height=${height}, left=100, top=100,`);
    }
</script>

<h2 id="congratulations">Congratulations!</h2>
<p><button type="button" onclick="showCompletionPopup();" class="largeButton">When you have finished this lab,<br />please click this button to let us know!</button></p>
<p>No personal information is collected; we only want to count how many people have completed the labs so we can continue to fund this work!</p>

<h3 id="known-issues">Known issues</h3>
<p>For the latest issues, or to file a bug report, see the <a href="https://github.com/microsoft/app-camp/issues" target="_blank">GitHub issues list</a> for this repository.</p>
<h2 id="next-steps">Next steps</h2>
<p>After completing this lab, you may continue with additional extended labs!</p>
<ul>
<li><a href="/app-camp/aad/ConfigurableTab">Add a Configurable Tab</a></li>
<li><a href="/app-camp/aad/Deeplink">Add a Deep link to a personal Tab</a></li>
<li><a href="/app-camp/aad/Dialog">Add a Dialog </a></li>
<li><a href="/app-camp/aad/MeetingConfigurableTab">Add a Meeting app</a></li>
<li><a href="/app-camp/aad/MessagingExtension">Add a Message Extension</a></li>
<li><a href="/app-camp/aad/Monetization">Selling Your SaaS-based Teams Extension</a></li>
<li><a href="/app-camp/aad/ExtendTeamsApp">Extend your Teams app to Outlook and Microsoft365 app</a></li>
</ul>
<p><img src="https://pnptelemetry.azurewebsites.net/app-camp/labs/monetization" /></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "toc.integrate"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
    
  </body>
</html>